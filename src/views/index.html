<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xero Bank Balances</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-university mr-2 text-blue-600"></i>
                        Xero Bank Balances
                    </h1>
                    <p class="text-gray-600 mt-1">View all connected bank account balances</p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/xero-agent" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-robot mr-1"></i>Login Agent
                    </a>
                    <button id="adminBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-cog mr-1"></i>Admin
                    </button>
                    <div id="authSection"><!-- Will be populated by JavaScript --></div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-600">Loading bank accounts...</p>
        </div>

        <!-- Not Authenticated State -->
        <div id="notAuthenticatedState" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-lock text-6xl text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Connect to Xero</h2>
            <p class="text-gray-600 mb-6">Please connect your Xero account to view bank account balances.</p>
            <a href="/auth/xero" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                <i class="fas fa-plug mr-2"></i>Connect to Xero
            </a>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-600 text-2xl mr-3"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800">Error</h3>
                    <p id="errorMessage" class="text-red-600"></p>
                </div>
            </div>
            <button onclick="loadBankAccounts()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-redo mr-1"></i>Retry
            </button>
        </div>

        <!-- Bank Accounts with Statement Lines -->
        <div id="accountsContainer" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    Bank Statement Lines (<span id="accountsCount">0</span> accounts, <span id="statementsCount">0</span> transactions)
                </h2>
                <div class="flex gap-2">
                    <button onclick="downloadAllStatements()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-1"></i>Download All
                    </button>
                    <button onclick="loadBankAccounts()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div id="accountsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Bank account cards will be inserted here -->
            </div>
        </div>

        <!-- No Accounts State -->
        <div id="noAccountsState" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-university text-6xl text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">No Bank Accounts Found</h2>
            <p class="text-gray-600">No bank accounts are currently connected to your Xero account.</p>
        </div>

        <!-- Transactions Modal -->
        <div id="transactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div>
                        <h2 id="modalAccountName" class="text-2xl font-semibold text-gray-800"></h2>
                        <p id="modalAccountCode" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <button onclick="closeTransactionsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Date Selector -->
                <div class="p-6 border-b border-gray-200 bg-gray-50">
                    <div class="flex flex-col md:flex-row gap-4 md:items-end">
                        <div class="flex flex-col">
                            <label for="rangeStart" class="text-sm font-medium text-gray-700 mb-1">From month</label>
                            <input type="month" id="rangeStart" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="rangeEnd" class="text-sm font-medium text-gray-700 mb-1">To month</label>
                            <input type="month" id="rangeEnd" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex gap-2">
                            <button id="applyRangeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                <i class="fas fa-sync-alt mr-1"></i>Apply Range
                            </button>
                            <button id="resetRangeBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm transition-colors">
                                <i class="fas fa-history mr-1"></i>Last 12 Months
                            </button>
                        </div>
                    </div>
                    <p id="transactionsRangeSummary" class="mt-3 text-sm text-gray-600"></p>
                    <div id="transactionsCacheWarning" class="hidden mt-3 text-sm text-amber-600 flex items-start gap-2">
                        <i class="fas fa-exclamation-triangle mt-0.5"></i>
                        <span id="transactionsCacheWarningText"></span>
                    </div>
                </div>

                <!-- Transactions Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Loading State -->
                    <div id="transactionsLoading" class="hidden text-center py-12">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600">Loading transactions...</p>
                    </div>

                    <!-- Error State -->
                    <div id="transactionsError" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3"></i>
                            <div>
                                <h3 class="text-lg font-semibold text-red-800">Error</h3>
                                <p id="transactionsErrorMessage" class="text-red-600"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div id="transactionsContainer" class="hidden">
                        <div class="mb-4 text-sm text-gray-600">
                            <div><span id="transactionsCount">0</span> transactions found</div>
                            <div id="transactionsCountPeriod" class="text-xs text-gray-500"></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Transactions will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- No Transactions State -->
                    <div id="noTransactionsState" class="hidden text-center py-12">
                        <i class="fas fa-receipt text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">No Transactions Found</h3>
                        <p id="noTransactionsMessage" class="text-gray-600">No transactions found for the selected period.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Detail Modal -->
        <div id="transactionDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800">Transaction Details</h2>
                        <p id="transactionDetailSubtitle" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <button id="closeTransactionDetailBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Date</p>
                            <p id="transactionDetailDate" class="text-sm text-gray-900 font-medium mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Amount</p>
                            <p id="transactionDetailAmount" class="text-sm text-gray-900 font-medium mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Type</p>
                            <span id="transactionDetailType" class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 mt-1">-</span>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Raw Type</p>
                            <p id="transactionDetailRawType" class="text-sm text-gray-900 font-medium mt-1 break-words">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Reference</p>
                            <p id="transactionDetailReference" class="text-sm text-gray-900 font-medium mt-1 break-words">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Contact</p>
                            <p id="transactionDetailContact" class="text-sm text-gray-900 font-medium mt-1 break-words">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Status</p>
                            <p id="transactionDetailStatus" class="text-sm text-gray-900 font-medium mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wide text-gray-500">Reconciled</p>
                            <p id="transactionDetailReconciled" class="text-sm text-gray-900 font-medium mt-1">-</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-wide text-gray-500 mb-2">Raw Transaction Payload</p>
                        <div class="border border-gray-200 rounded-lg bg-gray-50 p-4 overflow-x-auto">
                            <pre id="transactionDetailJson" class="text-xs text-gray-800 whitespace-pre-wrap break-words"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Modal -->
        <div id="adminModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800">Admin Panel</h2>
                        <p class="text-sm text-gray-500">Manage automated sync and run manual updates</p>
                    </div>
                    <button onclick="closeAdminModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 flex items-center justify-center">
                        <img src="/images/admin-panel.png" alt="Admin overview" class="max-h-56 w-full object-contain rounded-md">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <section class="border border-gray-200 rounded-lg p-4 space-y-4">
                            <header>
                                <h3 class="text-lg font-semibold text-gray-800">Nightly Sync Schedule</h3>
                                <p class="text-sm text-gray-500">Configure automatic overnight sync jobs.</p>
                            </header>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="nightlySyncEnabled" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="nightlySyncEnabled" class="text-sm text-gray-700">Enable nightly sync</label>
                            </div>
                            <div class="grid grid-cols-1 gap-4">
                                <label class="flex flex-col text-sm text-gray-700">
                                    Sync time (24h)
                                    <input type="time" id="nightlySyncTime" value="02:00" class="mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </label>
                                <label class="flex flex-col text-sm text-gray-700">
                                    Lookback period
                                    <select id="nightlySyncLookback" class="mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="1">Last 1 month</option>
                                        <option value="2">Last 2 months</option>
                                        <option value="3">Last 3 months</option>
                                        <option value="6">Last 6 months</option>
                                    </select>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <button id="saveNightlySyncBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    <i class="fas fa-save mr-1"></i>Save schedule
                                </button>
                                <button id="runNightlySyncBtn" class="text-sm text-indigo-600 hover:text-indigo-700">
                                    Run now
                                </button>
                            </div>
                            <p id="nightlySyncStatus" class="text-xs text-gray-500"></p>
                        </section>
                        <section class="border border-gray-200 rounded-lg p-4 space-y-4">
                            <header>
                                <h3 class="text-lg font-semibold text-gray-800">Manual Sync</h3>
                                <p class="text-sm text-gray-500">Select month(s) to sync immediately.</p>
                            </header>
                            <div class="border border-gray-200 rounded-lg max-h-56 overflow-y-auto p-3" id="manualSyncMonthContainer"></div>
                            <div class="flex items-center justify-between">
                                <button id="selectRecentMonthsBtn" class="text-sm text-indigo-600 hover:text-indigo-700">Select last 3 months</button>
                                <button id="clearManualSelectionBtn" class="text-sm text-gray-500 hover:text-gray-600">Clear</button>
                            </div>
                            <button id="startManualSyncBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors w-full">
                                <i class="fas fa-play mr-1"></i>Start manual sync
                            </button>
                            <p id="manualSyncStatus" class="text-xs text-gray-500"></p>
                        </section>
                    </div>
                    <section class="border border-gray-200 rounded-lg p-4">
                        <header class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Recent Sync Jobs</h3>
                                <p class="text-sm text-gray-500">Monitor the latest automatic and manual sync activity.</p>
                            </div>
                            <button id="refreshJobListBtn" class="text-sm text-indigo-600 hover:text-indigo-700">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                        </header>
                        <div id="adminJobList" class="space-y-3">
                            <p class="text-sm text-gray-500">No jobs to display.</p>
                        </div>
                    </section>
                </div>
            </div>
        </div>

    <script>
        const DEFAULT_NIGHTLY_TIME = '02:00';
        const MANUAL_MONTH_COUNT = 12;

        let currentAccountId = null;
        let currentAccountName = '';
        let currentAccountCode = '';
        let currentTransactions = [];

        let adminJobPollHandle = null;
        let adminJobIds = [];

        function formatMonthValue(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function monthValueToDate(value, endOfMonth = false) {
            if (!value) return null;
            const [yearStr, monthStr] = value.split('-');
            const year = Number(yearStr);
            const month = Number(monthStr);
            if (Number.isNaN(year) || Number.isNaN(month) || month < 1 || month > 12) {
                return null;
            }
            return endOfMonth ? new Date(year, month, 0) : new Date(year, month - 1, 1);
        }

        function setDefaultTransactionsRange() {
            const startInput = document.getElementById('rangeStart');
            const endInput = document.getElementById('rangeEnd');
            if (!startInput || !endInput) return;

            const now = new Date();
            const endMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startMonth = new Date(endMonth);
            startMonth.setMonth(startMonth.getMonth() - 11);

            startInput.value = formatMonthValue(startMonth);
            endInput.value = formatMonthValue(endMonth);
        }

        function updateTransactionsRangeSummary(rangeSummary) {
            const summaryText = document.getElementById('transactionsRangeSummary');
            const countPeriodText = document.getElementById('transactionsCountPeriod');

            if (!rangeSummary) {
                if (summaryText) summaryText.textContent = '';
                if (countPeriodText) countPeriodText.textContent = '';
                return;
            }

            const fromLabel = rangeSummary.fromDate ? new Date(rangeSummary.fromDate).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }) : '';
            const toLabel = rangeSummary.toDate ? new Date(rangeSummary.toDate).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }) : '';
            const monthsLabel = typeof rangeSummary.months === 'number' ? `${rangeSummary.months} month${rangeSummary.months === 1 ? '' : 's'}` : '';

            const summaryParts = [];
            if (fromLabel && toLabel) {
                summaryParts.push(`${fromLabel} → ${toLabel}`);
            }
            if (monthsLabel) {
                summaryParts.push(monthsLabel);
            }
            const statusParts = [];
            if (typeof rangeSummary.cachedMonths === 'number' && rangeSummary.cachedMonths > 0) {
                statusParts.push(`${rangeSummary.cachedMonths} cached`);
            }
            if (typeof rangeSummary.refreshedMonths === 'number' && rangeSummary.refreshedMonths > 0) {
                statusParts.push(`${rangeSummary.refreshedMonths} refreshed`);
            }
            if (typeof rangeSummary.missingMonths === 'number' && rangeSummary.missingMonths > 0) {
                statusParts.push(`${rangeSummary.missingMonths} missing`);
            }
            if (statusParts.length) {
                summaryParts.push(statusParts.join(' / '));
            }

            if (summaryText) {
                summaryText.textContent = summaryParts.length ? `Range: ${summaryParts.join(' · ')}` : '';
            }

            if (countPeriodText) {
                countPeriodText.textContent = summaryParts.length ? summaryParts.join(' · ') : '';
            }
        }

        function showTransactions(accountId, accountName, accountCode) {
            currentAccountId = accountId;
            currentAccountName = accountName;
            currentAccountCode = accountCode;

            const nameEl = document.getElementById('modalAccountName');
            const codeEl = document.getElementById('modalAccountCode');
            if (nameEl) nameEl.textContent = accountName;
            if (codeEl) codeEl.textContent = `Account Code: ${accountCode || 'N/A'}`;

            setDefaultTransactionsRange();

            const modal = document.getElementById('transactionsModal');
            if (modal) {
                modal.classList.remove('hidden');
            }

            loadTransactions();
        }

        function closeTransactionsModal() {
            const modal = document.getElementById('transactionsModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            currentAccountId = null;
        }

        async function loadTransactions() {
            if (!currentAccountId) return;

            const startInput = document.getElementById('rangeStart');
            const endInput = document.getElementById('rangeEnd');
            const errorState = document.getElementById('transactionsError');
            const errorMessage = document.getElementById('transactionsErrorMessage');
            const loadingState = document.getElementById('transactionsLoading');
            const transactionsContainer = document.getElementById('transactionsContainer');
            const noTransactionsState = document.getElementById('noTransactionsState');
            const cacheWarning = document.getElementById('transactionsCacheWarning');
            const cacheWarningText = document.getElementById('transactionsCacheWarningText');
            const noTransactionsMessage = document.getElementById('noTransactionsMessage');

            if (!startInput || !endInput) {
                return;
            }

            const startValue = startInput.value;
            const endValue = endInput.value;

            const showLoading = () => {
                if (loadingState) loadingState.classList.remove('hidden');
                if (transactionsContainer) transactionsContainer.classList.add('hidden');
                if (noTransactionsState) noTransactionsState.classList.add('hidden');
                if (errorState) errorState.classList.add('hidden');
                if (cacheWarning) cacheWarning.classList.add('hidden');
                if (cacheWarningText) cacheWarningText.textContent = '';
            };

            if (!startValue || !endValue) {
                showLoading();
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
                if (errorMessage) errorMessage.textContent = 'Please select both start and end months.';
                return;
            }

            if (startValue > endValue) {
                showLoading();
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
                if (errorMessage) errorMessage.textContent = 'Start month must be before or the same as end month.';
                return;
            }

            const fromDate = monthValueToDate(startValue, false);
            const toDate = monthValueToDate(endValue, true);

            if (!fromDate || !toDate) {
                showLoading();
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
                if (errorMessage) errorMessage.textContent = 'Unable to parse the selected months. Please try again.';
                return;
            }

            showLoading();
            updateTransactionsRangeSummary({ fromDate: fromDate.toISOString(), toDate: toDate.toISOString(), months: null });

            try {
                const params = new URLSearchParams({
                    fromDate: fromDate.toISOString().split('T')[0],
                    toDate: toDate.toISOString().split('T')[0],
                    accountName: currentAccountName || '',
                    accountCode: currentAccountCode || '',
                });

                const response = await fetch(`/api/xero/accounts/${currentAccountId}/transactions?${params.toString()}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch transactions');
                }

                const missingDetails = Array.isArray(data.missingMonths)
                    ? data.missingMonths
                    : Array.isArray(data.range?.missingMonthDetails)
                        ? data.range.missingMonthDetails
                        : [];

                if (loadingState) loadingState.classList.add('hidden');

                const rangePayload = data.range || { fromDate: data.fromDate, toDate: data.toDate, months: data.range?.months };
                updateTransactionsRangeSummary(rangePayload);

                if (cacheWarning && cacheWarningText) {
                    if (missingDetails.length > 0) {
                        const preview = missingDetails
                            .slice(0, 6)
                            .map((item) => `${String(item.month).padStart(2, '0')}/${item.year}`)
                            .join(', ');
                        const extraText = missingDetails.length > 6 ? `, +${missingDetails.length - 6} more` : '';
                        cacheWarning.classList.remove('hidden');
                        cacheWarningText.textContent = `Missing cached data for ${missingDetails.length} month${missingDetails.length === 1 ? '' : 's'} (${preview}${extraText}). Run a sync from the Admin panel to backfill.`;
                    } else {
                        cacheWarning.classList.add('hidden');
                        cacheWarningText.textContent = '';
                    }
                }

                if (Array.isArray(data.transactions) && data.transactions.length > 0) {
                    displayTransactions(data.transactions);
                    const countEl = document.getElementById('transactionsCount');
                    if (countEl) countEl.textContent = data.count;
                    if (transactionsContainer) transactionsContainer.classList.remove('hidden');
                    if (noTransactionsState) noTransactionsState.classList.add('hidden');
                    if (noTransactionsMessage) {
                        noTransactionsMessage.textContent = 'No transactions found for the selected period.';
                    }
                } else {
                    if (transactionsContainer) transactionsContainer.classList.add('hidden');
                    if (noTransactionsState) noTransactionsState.classList.remove('hidden');
                    if (noTransactionsMessage) {
                        if (missingDetails.length > 0) {
                            noTransactionsMessage.textContent = `No cached transactions found for the selected period. Missing ${missingDetails.length} month${missingDetails.length === 1 ? '' : 's'} of cached data. Run a sync from the Admin panel to populate these months.`;
                        } else {
                            noTransactionsMessage.textContent = 'No transactions found for the selected period.';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading transactions', error);
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
                if (errorMessage) errorMessage.textContent = error instanceof Error ? error.message : 'Failed to load transactions. Please try again.';
                if (cacheWarning) cacheWarning.classList.add('hidden');
                if (cacheWarningText) cacheWarningText.textContent = '';
            }
        }

        function determineTransactionTypeInfo(transaction) {
            const typeValue = transaction?.type ? String(transaction.type).toUpperCase() : '';
            const amount = typeof transaction?.amount === 'number' ? transaction.amount : 0;

            const isCreditIndicator =
                typeValue.includes('RECEIVE') ||
                typeValue.includes('CREDIT') ||
                typeValue.includes('OVERPAYMENT') ||
                typeValue.includes('PREPAYMENT');

            const isDebitIndicator =
                typeValue.includes('SPEND') ||
                typeValue.includes('DEBIT') ||
                typeValue.includes('PAYMENT') ||
                typeValue.includes('WITHDRAWAL');

            let isCredit;

            if (isCreditIndicator && !isDebitIndicator) {
                isCredit = true;
            } else if (isDebitIndicator && !isCreditIndicator) {
                isCredit = false;
            } else {
                isCredit = amount >= 0;
            }

            return {
                label: isCredit ? 'Credit' : 'Debit',
                badgeClass: isCredit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800',
                rawType: typeValue || 'N/A',
                isCredit,
            };
        }

        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionsTableBody');
            if (!tbody) return;

            currentTransactions = Array.isArray(transactions) ? transactions.slice() : [];

            tbody.innerHTML = currentTransactions.map((tx) => {
                const typeInfo = determineTransactionTypeInfo(tx);
                return `
                <tr class="hover:bg-blue-50 transition-colors cursor-pointer">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatTransactionDate(tx.date)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${escapeHtml(tx.description)}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${tx.reference ? escapeHtml(tx.reference) : '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${tx.contactName ? escapeHtml(tx.contactName) : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${tx.amount >= 0 ? 'text-green-600' : 'text-red-600'}">${tx.amountFormatted}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${typeInfo.badgeClass}">
                            ${typeInfo.label}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${tx.isReconciled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${tx.isReconciled ? 'Reconciled' : 'Unreconciled'}
                        </span>
                    </td>
                </tr>
            `;
            }).join('');

            Array.from(tbody.querySelectorAll('tr')).forEach((row, index) => {
                row.addEventListener('click', () => openTransactionDetail(index));
            });
        }

        function formatTransactionDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Failed to check auth status', error);
                return false;
            }
        }

        async function loadBankAccounts() {
            const loadingState = document.getElementById('loadingState');
            const accountsContainer = document.getElementById('accountsContainer');
            const noAccountsState = document.getElementById('noAccountsState');
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');

            if (loadingState) loadingState.classList.remove('hidden');
            if (accountsContainer) accountsContainer.classList.add('hidden');
            if (noAccountsState) noAccountsState.classList.add('hidden');
            if (errorState) errorState.classList.add('hidden');

            try {
                const response = await fetch('/api/xero/statements/by-account');
                const data = await response.json();

                if (response.status === 401) {
                    showNotAuthenticatedState();
                    return;
                }

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch bank statement lines');
                }

                if (loadingState) loadingState.classList.add('hidden');

                if (data.success && Array.isArray(data.accounts) && data.accounts.length > 0) {
                    displayBankAccounts(data.accounts);
                    if (accountsContainer) accountsContainer.classList.remove('hidden');
                } else if (noAccountsState) {
                    noAccountsState.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading bank statement lines', error);
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) errorState.classList.remove('hidden');
                if (errorMessage) errorMessage.textContent = error instanceof Error ? error.message : 'Failed to load bank statement lines. Please try again.';
            }
        }

        let allAccountsData = [];

        function displayBankAccounts(accounts) {
            allAccountsData = accounts; // Store for download all
            const grid = document.getElementById('accountsGrid');
            const countElement = document.getElementById('accountsCount');
            const statementsCountElement = document.getElementById('statementsCount');
            if (!grid || !countElement) return;

            const totalStatements = accounts.reduce((sum, acc) => sum + (acc.statements?.length || 0), 0);
            countElement.textContent = accounts.length;
            if (statementsCountElement) {
                statementsCountElement.textContent = totalStatements;
            }

            grid.innerHTML = accounts.map((account, index) => {
                const statements = account.statements || [];
                const lastCollected = account.lastCollectedAt ? new Date(account.lastCollectedAt).toLocaleDateString() : 'Never';
                
                return `
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="viewAccountTransactions('${escapeHtml(account.accountId)}', ${index})">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-university text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">${escapeHtml(account.accountName || account.accountId)}</h3>
                                    <p class="text-sm text-gray-500">${statements.length} transactions</p>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 pt-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-600">Last collected:</span>
                                <span class="text-gray-800 font-medium">${lastCollected}</span>
                            </div>
                            <div class="mt-3 flex gap-2">
                                <button onclick="event.stopPropagation(); viewAccountTransactions('${escapeHtml(account.accountId)}', ${index})" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                <button onclick="event.stopPropagation(); downloadAccountStatements('${escapeHtml(account.accountId)}', ${index})" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    <i class="fas fa-download mr-1"></i>Download
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewAccountTransactions(accountId, accountIndex) {
            const account = allAccountsData[accountIndex];
            if (!account) {
                console.error('Account not found at index', accountIndex);
                return;
            }

            const statements = account.statements || [];
            console.log('Viewing transactions for account:', account.accountName, 'Statements count:', statements.length, 'Sample:', statements[0]);
            
            if (statements.length === 0) {
                alert('No transactions available for this account');
                return;
            }
            
            // Sort by date descending (latest first)
            const sortedStatements = [...statements].sort((a, b) => {
                const dateA = a.statementDate ? new Date(a.statementDate) : new Date(0);
                const dateB = b.statementDate ? new Date(b.statementDate) : new Date(0);
                return dateB - dateA; // Descending
            });

            // Create modal content
            let modal = document.getElementById('accountTransactionsModal');
            if (!modal) {
                // Remove any existing modal first to avoid duplicates
                const existingModal = document.getElementById('accountTransactionsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                // Create modal if it doesn't exist
                const modalHtml = `
                    <div id="accountTransactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                                <div>
                                    <h2 id="modalAccountName" class="text-2xl font-semibold text-gray-800"></h2>
                                    <p id="modalTransactionCount" class="text-sm text-gray-500 mt-1"></p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="downloadCurrentAccountStatements()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-download mr-1"></i>Download
                                    </button>
                                    <button onclick="closeAccountTransactionsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                        <i class="fas fa-times text-2xl"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-6">
                                <div class="mb-4">
                                    <input type="text" id="dateFilterInput" placeholder="Filter by date (YYYY-MM-DD)..." class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full max-w-xs" onkeyup="filterTransactionsByDate()">
                                    <button onclick="sortTransactionsByDate()" class="ml-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-sort mr-1"></i>Sort Date
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200" id="transactionsTable">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTransactionsByDate()">
                                                    Date <i class="fas fa-sort ml-1"></i>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Spent</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Received</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="accountTransactionsTableBody" class="bg-white divide-y divide-gray-200">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById('accountTransactionsModal');
                // Wait a tiny bit for DOM to be ready
                await new Promise(resolve => setTimeout(resolve, 10));
            }

            const modalAccountNameEl = document.getElementById('modalAccountName');
            const modalTransactionCountEl = document.getElementById('modalTransactionCount');
            
            if (modalAccountNameEl) {
                modalAccountNameEl.textContent = account.accountName || account.accountId;
            }
            if (modalTransactionCountEl) {
                modalTransactionCountEl.textContent = `${sortedStatements.length} transactions`;
            }

            // Store current account data for download
            window.currentAccountData = { accountId, accountName: account.accountName, statements: sortedStatements };

            // Render transactions - use the specific tbody ID for account transactions
            // Use a small delay to ensure DOM is fully ready
            setTimeout(() => {
                const tbody = document.getElementById('accountTransactionsTableBody');
                console.log('Looking for accountTransactionsTableBody, found:', tbody);
                if (!tbody) {
                    console.error('accountTransactionsTableBody not found after modal creation');
                    // Try once more
                    setTimeout(() => {
                        renderAccountTransactionsTable(sortedStatements);
                        if (modal) modal.classList.remove('hidden');
                    }, 200);
                } else {
                    console.log('tbody found, rendering transactions');
                    renderAccountTransactionsTable(sortedStatements, tbody);
                    if (modal) modal.classList.remove('hidden');
                }
            }, 50);
        }

        let dateSortDirection = 'desc'; // 'desc' or 'asc'

        function renderAccountTransactionsTable(statements, tbodyElement = null) {
            console.log('renderAccountTransactionsTable called with', statements.length, 'statements');
            console.log('Sample statement:', statements[0]);
            
            currentTransactions = statements;
            const tbody = tbodyElement || document.getElementById('accountTransactionsTableBody');
            if (!tbody) {
                console.error('accountTransactionsTableBody not found!');
                return;
            }

            if (!statements || statements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">No transactions found</td></tr>';
                console.log('No statements to render');
                return;
            }

            // Clear first
            tbody.innerHTML = '';
            
            // Parse and format dates more robustly
            const rows = statements.map((stmt, index) => {
                // Handle both possible property names
                const dateStr = stmt.statementDate || stmt.date || '';
                const description = stmt.description || '';
                const reference = stmt.reference || '';
                const spent = stmt.spent || '';
                const received = stmt.received || '';
                const balance = stmt.balance || '';
                
                // Try to parse date - handle various formats
                let formattedDate = dateStr;
                try {
                    if (dateStr) {
                        const dateObj = new Date(dateStr);
                        if (!isNaN(dateObj.getTime())) {
                            formattedDate = dateObj.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        }
                    }
                } catch (e) {
                    // If date parsing fails, use original string
                    formattedDate = dateStr;
                }
                
                return `
                    <tr class="hover:bg-gray-50 transaction-row" data-date="${escapeHtml(dateStr)}">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${escapeHtml(formattedDate)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${escapeHtml(description)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${escapeHtml(reference || '')}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right ${spent ? 'text-red-600' : 'text-gray-400'}">${escapeHtml(spent || '')}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right ${received ? 'text-green-600' : 'text-gray-400'}">${escapeHtml(received || '')}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-medium text-gray-900">${escapeHtml(balance || '')}</td>
                    </tr>
                `;
            });
            
            // Insert all rows at once
            const htmlContent = rows.join('');
            tbody.innerHTML = htmlContent;
            
            console.log('Rendered', statements.length, 'rows. tbody.innerHTML length:', tbody.innerHTML.length);
            console.log('tbody children count:', tbody.children.length);
            console.log('First row HTML:', rows[0]?.substring(0, 200));
            
            // Verify the rows are actually in the DOM
            const renderedRows = tbody.querySelectorAll('tr');
            console.log('QuerySelector found', renderedRows.length, 'rows');
            
            if (renderedRows.length === 0 && statements.length > 0) {
                console.error('Rows were not inserted! Trying appendChild method...');
                // Try alternative method
                rows.forEach(rowHtml => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = rowHtml;
                    const rowElement = tempDiv.firstElementChild;
                    if (rowElement) {
                        tbody.appendChild(rowElement);
                    }
                });
                console.log('After appendChild, tbody children:', tbody.children.length);
            }
        }

        function sortTransactionsByDate() {
            dateSortDirection = dateSortDirection === 'desc' ? 'asc' : 'desc';
            const sorted = [...currentTransactions].sort((a, b) => {
                const dateA = a.statementDate ? new Date(a.statementDate) : new Date(0);
                const dateB = b.statementDate ? new Date(b.statementDate) : new Date(0);
                return dateSortDirection === 'desc' ? dateB - dateA : dateA - dateB;
            });
            const tbody = document.getElementById('accountTransactionsTableBody');
            renderAccountTransactionsTable(sorted, tbody);
        }

        function filterTransactionsByDate() {
            const filterInput = document.getElementById('dateFilterInput');
            if (!filterInput) return;
            const filterValue = filterInput.value.toLowerCase();
            const tbody = document.getElementById('accountTransactionsTableBody');
            const rows = tbody ? tbody.querySelectorAll('.transaction-row') : document.querySelectorAll('.transaction-row');
            
            rows.forEach(row => {
                const date = row.getAttribute('data-date') || '';
                if (date.toLowerCase().includes(filterValue) || filterValue === '') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function closeAccountTransactionsModal() {
            const modal = document.getElementById('accountTransactionsModal');
            if (modal) modal.classList.add('hidden');
            window.currentAccountData = null;
        }

        function downloadAccountStatements(accountId, accountIndex) {
            const account = allAccountsData[accountIndex];
            if (!account) return;
            downloadStatementsAsCSV(account.accountName || accountId, account.statements || []);
        }

        function downloadCurrentAccountStatements() {
            if (!window.currentAccountData) return;
            downloadStatementsAsCSV(window.currentAccountData.accountName || window.currentAccountData.accountId, window.currentAccountData.statements);
        }

        function downloadAllStatements() {
            if (!allAccountsData || allAccountsData.length === 0) {
                alert('No statement data available to download');
                return;
            }

            // Combine all statements with account names
            const allStatements = [];
            allAccountsData.forEach(account => {
                (account.statements || []).forEach(stmt => {
                    allStatements.push({
                        Account: account.accountName || account.accountId,
                        Date: stmt.statementDate || '',
                        Description: stmt.description || '',
                        Reference: stmt.reference || '',
                        Spent: stmt.spent || '',
                        Received: stmt.received || '',
                        Balance: stmt.balance || ''
                    });
                });
            });

            downloadStatementsAsCSV('All_Accounts', allStatements, true);
        }

        function downloadStatementsAsCSV(accountName, statements, isAllAccounts = false) {
            if (!statements || statements.length === 0) {
                alert('No transactions to download');
                return;
            }

            // Sort by date descending
            const sorted = [...statements].sort((a, b) => {
                const dateA = a.statementDate ? new Date(a.statementDate) : new Date(0);
                const dateB = b.statementDate ? new Date(b.statementDate) : new Date(0);
                return dateB - dateA;
            });

            // Create CSV
            const headers = isAllAccounts 
                ? ['Account', 'Date', 'Description', 'Reference', 'Spent', 'Received', 'Balance']
                : ['Date', 'Description', 'Reference', 'Spent', 'Received', 'Balance'];
            
            const rows = sorted.map(stmt => {
                const date = stmt.statementDate ? new Date(stmt.statementDate).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '';
                if (isAllAccounts) {
                    return [
                        accountName,
                        date,
                        `"${(stmt.Description || stmt.description || '').replace(/"/g, '""')}"`,
                        `"${(stmt.Reference || stmt.reference || '').replace(/"/g, '""')}"`,
                        stmt.Spent || stmt.spent || '',
                        stmt.Received || stmt.received || '',
                        stmt.Balance || stmt.balance || ''
                    ];
                } else {
                    return [
                        date,
                        `"${(stmt.description || '').replace(/"/g, '""')}"`,
                        `"${(stmt.reference || '').replace(/"/g, '""')}"`,
                        stmt.spent || '',
                        stmt.received || '',
                        stmt.balance || ''
                    ];
                }
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${accountName.replace(/[^a-z0-9]/gi, '_')}_statements_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showNotAuthenticatedState() {
            const loading = document.getElementById('loadingState');
            const accounts = document.getElementById('accountsContainer');
            const noAccounts = document.getElementById('noAccountsState');
            const error = document.getElementById('errorState');
            const notAuth = document.getElementById('notAuthenticatedState');

            if (loading) loading.classList.add('hidden');
            if (accounts) accounts.classList.add('hidden');
            if (noAccounts) noAccounts.classList.add('hidden');
            if (error) error.classList.add('hidden');
            if (notAuth) notAuth.classList.remove('hidden');
        }

        async function updateAuthSection() {
            const authSection = document.getElementById('authSection');
            if (!authSection) return;
            const isAuthenticated = await checkAuthStatus();

            if (isAuthenticated) {
                authSection.innerHTML = `
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </button>
                `;
            } else {
                authSection.innerHTML = `
                    <a href="/auth/xero" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plug mr-1"></i>Connect to Xero
                    </a>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text ?? '';
            return div.innerHTML;
        }

        function openTransactionDetail(index) {
            if (!Array.isArray(currentTransactions) || index < 0 || index >= currentTransactions.length) {
                return;
            }

            const transaction = currentTransactions[index];
            const modal = document.getElementById('transactionDetailModal');
            const subtitle = document.getElementById('transactionDetailSubtitle');
            const dateEl = document.getElementById('transactionDetailDate');
            const amountEl = document.getElementById('transactionDetailAmount');
            const typeEl = document.getElementById('transactionDetailType');
            const rawTypeEl = document.getElementById('transactionDetailRawType');
            const referenceEl = document.getElementById('transactionDetailReference');
            const contactEl = document.getElementById('transactionDetailContact');
            const statusEl = document.getElementById('transactionDetailStatus');
            const reconciledEl = document.getElementById('transactionDetailReconciled');
            const jsonEl = document.getElementById('transactionDetailJson');

            const typeInfo = determineTransactionTypeInfo(transaction);

            if (subtitle) {
                subtitle.textContent = transaction.transactionId ? `Transaction ID: ${transaction.transactionId}` : 'Transaction';
            }

            if (dateEl) {
                dateEl.textContent = formatTransactionDate(transaction.date) || '-';
            }

            if (amountEl) {
                amountEl.textContent = transaction.amountFormatted || `${transaction.amount ?? 0}`;
                amountEl.className = `text-sm font-medium mt-1 ${typeInfo.isCredit ? 'text-green-700' : 'text-red-700'}`;
            }

            if (typeEl) {
                typeEl.textContent = typeInfo.label;
                typeEl.className = `inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full mt-1 ${typeInfo.badgeClass}`;
            }

            if (rawTypeEl) {
                rawTypeEl.textContent = transaction.type ? String(transaction.type) : '—';
            }

            if (referenceEl) {
                referenceEl.textContent = transaction.reference ? String(transaction.reference) : '—';
            }

            if (contactEl) {
                contactEl.textContent = transaction.contactName ? String(transaction.contactName) : '—';
            }

            if (statusEl) {
                statusEl.textContent = transaction.status ? String(transaction.status) : '—';
            }

            if (reconciledEl) {
                reconciledEl.textContent = transaction.isReconciled ? 'Yes' : 'No';
            }

            if (jsonEl) {
                jsonEl.textContent = JSON.stringify(transaction, null, 2);
            }

            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeTransactionDetail() {
            const modal = document.getElementById('transactionDetailModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function logout() {
            try {
                const response = await fetch('/auth/logout', { method: 'POST' });
                if (response.ok || response.redirected) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Logout failed', error);
                window.location.reload();
            }
        }

        function openAdminModal() {
            const modal = document.getElementById('adminModal');
            if (!modal) return;
            populateManualSyncMonths();
            loadAdminSettings();
            refreshJobList();
            modal.classList.remove('hidden');
        }

        function closeAdminModal() {
            const modal = document.getElementById('adminModal');
            if (modal) modal.classList.add('hidden');
            stopJobPolling();
        }

        function populateManualSyncMonths() {
            const container = document.getElementById('manualSyncMonthContainer');
            if (!container) return;

            const now = new Date();
            const months = [];
            for (let i = 0; i < MANUAL_MONTH_COUNT; i += 1) {
                months.push(new Date(now.getFullYear(), now.getMonth() - i, 1));
            }

            container.innerHTML = months.map((date, index) => {
                const monthValue = formatMonthValue(date);
                const label = date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                return `
                    <label class="flex items-center justify-between py-1 px-2 rounded hover:bg-gray-100">
                        <span class="text-sm text-gray-700">${label}</span>
                        <input type="checkbox" class="manual-month-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded" data-month="${monthValue}" ${index < 3 ? 'checked' : ''}>
                    </label>
                `;
            }).join('');
        }

        function getSelectedManualMonths() {
            return Array.from(document.querySelectorAll('.manual-month-checkbox'))
                .filter((checkbox) => checkbox.checked)
                .map((checkbox) => checkbox.getAttribute('data-month'))
                .filter(Boolean);
        }

        function selectRecentMonths(count = 3) {
            const checkboxes = Array.from(document.querySelectorAll('.manual-month-checkbox'));
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = index < count;
            });
        }

        function clearManualMonthSelection() {
            const checkboxes = document.querySelectorAll('.manual-month-checkbox');
            checkboxes.forEach((checkbox) => {
                checkbox.checked = false;
            });
        }

        async function loadAdminSettings() {
            setNightlySyncStatus('Loading settings...', 'info');
            try {
                const response = await fetch('/api/admin/settings');
                if (!response.ok) {
                    throw new Error('Failed to load admin settings');
                }
                const data = await response.json();
                applyAdminSettingsToForm(data.settings || {});
                setNightlySyncStatus('Settings loaded', 'muted');
            } catch (error) {
                console.error('Failed to load admin settings', error);
                applyAdminSettingsToForm({});
                setNightlySyncStatus('Unable to load settings. Using defaults.', 'warning');
            }
        }

        function applyAdminSettingsToForm(settings) {
            const enabledInput = document.getElementById('nightlySyncEnabled');
            const timeInput = document.getElementById('nightlySyncTime');
            const lookbackSelect = document.getElementById('nightlySyncLookback');

            if (enabledInput) enabledInput.checked = settings.enabled ?? false;
            if (timeInput) timeInput.value = settings.time || DEFAULT_NIGHTLY_TIME;
            if (lookbackSelect) lookbackSelect.value = String(settings.lookbackMonths || 1);
        }

        async function saveNightlySyncSettings() {
            const enabledInput = document.getElementById('nightlySyncEnabled');
            const timeInput = document.getElementById('nightlySyncTime');
            const lookbackSelect = document.getElementById('nightlySyncLookback');
            const saveBtn = document.getElementById('saveNightlySyncBtn');

            const payload = {
                enabled: enabledInput ? enabledInput.checked : false,
                time: timeInput?.value || DEFAULT_NIGHTLY_TIME,
                lookbackMonths: Number(lookbackSelect?.value || '1'),
            };

            setNightlySyncStatus('Saving...', 'info');
            setButtonLoading(saveBtn, true);

            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.error || 'Failed to save settings');
                }
                setNightlySyncStatus('Settings saved successfully.', 'success');
            } catch (error) {
                console.error('Failed to save nightly settings', error);
                setNightlySyncStatus(error instanceof Error ? error.message : 'Failed to save settings.', 'danger');
            } finally {
                setButtonLoading(saveBtn, false);
            }
        }

        async function runNightlySyncNow(event) {
            if (event) event.preventDefault();
            const button = document.getElementById('runNightlySyncBtn');
            setButtonLoading(button, true);
            setNightlySyncStatus('Starting scheduled sync...', 'info');
            try {
                const response = await fetch('/api/admin/sync/run-nightly', { method: 'POST' });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start nightly sync');
                }
                setNightlySyncStatus(data.message || 'Nightly sync started successfully.', 'success');
                if (Array.isArray(data.jobs) && data.jobs.length) {
                    startJobPolling(data.jobs.map((job) => job.jobId));
                }
                refreshJobList();
            } catch (error) {
                console.error('Failed to start nightly sync', error);
                setNightlySyncStatus(error instanceof Error ? error.message : 'Failed to start nightly sync.', 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function startManualSync(event) {
            if (event) event.preventDefault();
            const button = document.getElementById('startManualSyncBtn');
            const months = getSelectedManualMonths();

            if (!months.length) {
                setManualSyncStatus('Please select at least one month to sync.', 'warning');
                return;
            }

            setManualSyncStatus('Starting manual sync...', 'info');
            setButtonLoading(button, true);
            try {
                const response = await fetch('/api/admin/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ months }),
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start manual sync');
                }
                setManualSyncStatus(data.message || 'Manual sync started.', 'success');
                if (Array.isArray(data.jobs) && data.jobs.length) {
                    startJobPolling(data.jobs.map((job) => job.jobId));
                }
                refreshJobList();
            } catch (error) {
                console.error('Failed to start manual sync', error);
                setManualSyncStatus(error instanceof Error ? error.message : 'Failed to start manual sync.', 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        }

        function setNightlySyncStatus(message, variant = 'info') {
            const statusEl = document.getElementById('nightlySyncStatus');
            if (!statusEl) return;
            const classes = {
                info: 'text-gray-500',
                success: 'text-green-600',
                warning: 'text-amber-600',
                danger: 'text-red-600',
                muted: 'text-gray-400',
            };
            statusEl.className = `text-xs ${classes[variant] || classes.info}`;
            statusEl.textContent = message;
        }

        function setManualSyncStatus(message, variant = 'info') {
            const statusEl = document.getElementById('manualSyncStatus');
            if (!statusEl) return;
            const classes = {
                info: 'text-gray-500',
                success: 'text-green-600',
                warning: 'text-amber-600',
                danger: 'text-red-600',
                muted: 'text-gray-400',
            };
            statusEl.className = `text-xs ${classes[variant] || classes.info}`;
            statusEl.textContent = message;
        }

        function setButtonLoading(button, isLoading) {
            if (!button) return;
            if (isLoading) {
                button.dataset.originalText = button.textContent;
                button.textContent = 'Working...';
                button.disabled = true;
                button.classList.add('opacity-70', 'cursor-not-allowed');
            } else {
                button.textContent = button.dataset.originalText || button.textContent;
                button.disabled = false;
                button.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        async function refreshJobList() {
            const container = document.getElementById('adminJobList');
            if (!container) return;
            container.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
            try {
                const response = await fetch('/api/admin/jobs/recent?limit=10');
                if (!response.ok) {
                    throw new Error('Failed to load recent jobs');
                }
                const data = await response.json();
                renderJobList(Array.isArray(data.jobs) ? data.jobs : []);
            } catch (error) {
                console.error('Failed to load recent jobs', error);
                container.innerHTML = '<p class="text-sm text-red-600">Failed to load recent jobs.</p>';
            }
        }

        function renderJobList(jobs) {
            const container = document.getElementById('adminJobList');
            if (!container) return;
            if (!jobs.length) {
                container.innerHTML = '<p class="text-sm text-gray-500">No jobs to display.</p>';
                return;
            }

            container.innerHTML = jobs.map((job) => {
                const label = `${String(job.month).padStart(2, '0')}/${job.year}`;
                const statusBadge = formatJobStatus(job.status);
                const startedAt = job.startedAt ? new Date(job.startedAt).toLocaleString('en-GB') : '—';
                const completedAt = job.completedAt ? new Date(job.completedAt).toLocaleString('en-GB') : null;
                const duration = job.startedAt && job.completedAt
                    ? `${Math.round((new Date(job.completedAt).getTime() - new Date(job.startedAt).getTime()) / 1000)}s`
                    : '—';

                return `
                    <div class="border border-gray-200 rounded-lg p-3 flex justify-between items-start">
                        <div>
                            <div class="text-sm font-medium text-gray-800">${escapeHtml(label)}</div>
                            <div class="text-xs text-gray-500">Started: ${escapeHtml(startedAt)}</div>
                            <div class="text-xs text-gray-500">Duration: ${escapeHtml(duration)}</div>
                            ${job.lastAccountName ? `<div class="text-xs text-gray-400">Last account: ${escapeHtml(job.lastAccountName)}</div>` : ''}
                            ${job.error ? `<div class="text-xs text-red-600 mt-1">Error: ${escapeHtml(job.error)}</div>` : ''}
                        </div>
                        <div class="text-xs font-semibold uppercase tracking-wide ${statusBadge.class}">${statusBadge.label}</div>
                    </div>
                `;
            }).join('');
        }

        function formatJobStatus(status) {
            const map = {
                pending: { label: 'Pending', class: 'text-amber-600' },
                running: { label: 'Running', class: 'text-blue-600' },
                succeeded: { label: 'Completed', class: 'text-green-600' },
                failed: { label: 'Failed', class: 'text-red-600' },
            };
            return map[status] || { label: 'Unknown', class: 'text-gray-500' };
        }

        async function fetchJobById(jobId) {
            try {
                const response = await fetch(`/api/xero/cache/job/${jobId}`);
                if (response.status === 404) {
                    return null;
                }
                if (!response.ok) {
                    throw new Error('Failed to fetch job');
                }
                const data = await response.json();
                return data.job || null;
            } catch (error) {
                console.warn('Failed to fetch job', error);
                return null;
            }
        }

        function startJobPolling(jobIds) {
            adminJobIds = jobIds.filter(Boolean);
            if (!adminJobIds.length) {
                stopJobPolling();
                return;
            }
            stopJobPolling();
            pollTrackedJobs();
            adminJobPollHandle = setInterval(pollTrackedJobs, 5000);
        }

        async function pollTrackedJobs() {
            if (!adminJobIds.length) {
                stopJobPolling();
                return;
            }
            try {
                const jobs = (await Promise.all(adminJobIds.map(fetchJobById))).filter(Boolean);

                if (jobs.length) {
                    renderJobList(jobs);
                }

                const active = jobs.filter((job) => job.status !== 'succeeded' && job.status !== 'failed');
                adminJobIds = active.map((job) => job.jobId);

                if (!adminJobIds.length) {
                    stopJobPolling();
                    refreshJobList();
                }
            } catch (error) {
                console.warn('Failed to poll jobs', error);
            }
        }

        function stopJobPolling() {
            if (adminJobPollHandle) {
                clearInterval(adminJobPollHandle);
                adminJobPollHandle = null;
            }
            adminJobIds = [];
        }

        function handleDocumentClick(event) {
            const transactionsModal = document.getElementById('transactionsModal');
            if (transactionsModal && event.target === transactionsModal) {
                closeTransactionsModal();
            }

            const adminModal = document.getElementById('adminModal');
            if (adminModal && event.target === adminModal) {
                closeAdminModal();
            }

            const transactionDetailModal = document.getElementById('transactionDetailModal');
            if (transactionDetailModal && event.target === transactionDetailModal) {
                closeTransactionDetail();
            }
        }

        document.addEventListener('click', handleDocumentClick);
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeTransactionDetail();
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            setDefaultTransactionsRange();
            populateManualSyncMonths();
            await updateAuthSection();
            const isAuthenticated = await checkAuthStatus();

            const applyRangeBtn = document.getElementById('applyRangeBtn');
            if (applyRangeBtn) {
                applyRangeBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    loadTransactions();
                });
            }

            const resetRangeBtn = document.getElementById('resetRangeBtn');
            if (resetRangeBtn) {
                resetRangeBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    setDefaultTransactionsRange();
                    if (currentAccountId) {
                        loadTransactions();
                    }
                });
            }

            const adminBtn = document.getElementById('adminBtn');
            if (adminBtn) {
                adminBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    openAdminModal();
                });
            }

            const saveScheduleBtn = document.getElementById('saveNightlySyncBtn');
            if (saveScheduleBtn) {
                saveScheduleBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    saveNightlySyncSettings();
                });
            }

            const runScheduleBtn = document.getElementById('runNightlySyncBtn');
            if (runScheduleBtn) {
                runScheduleBtn.addEventListener('click', runNightlySyncNow);
            }

            const manualSyncBtn = document.getElementById('startManualSyncBtn');
            if (manualSyncBtn) {
                manualSyncBtn.addEventListener('click', startManualSync);
            }

            const refreshJobsBtn = document.getElementById('refreshJobListBtn');
            if (refreshJobsBtn) {
                refreshJobsBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    refreshJobList();
                });
            }

            const selectRecentBtn = document.getElementById('selectRecentMonthsBtn');
            if (selectRecentBtn) {
                selectRecentBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    selectRecentMonths(3);
                });
            }

            const clearSelectionBtn = document.getElementById('clearManualSelectionBtn');
            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    clearManualMonthSelection();
                });
            }

            const closeTransactionDetailBtn = document.getElementById('closeTransactionDetailBtn');
            if (closeTransactionDetailBtn) {
                closeTransactionDetailBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    closeTransactionDetail();
                });
            }

            if (isAuthenticated) {
                await loadBankAccounts();
            } else {
                showNotAuthenticatedState();
            }
        });
    </script>
</body>
</html>

