<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xero Bank Balances</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-university mr-2 text-blue-600"></i>
                        Xero Bank Balances
                    </h1>
                    <p class="text-gray-600 mt-1">View all connected bank account balances</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="hundredTransactionsBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-list-ol mr-1"></i>100 Transactions
                    </button>
                    <button id="allTransactionsBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-list mr-1"></i>All Transactions
                    </button>
                    <div id="authSection"><!-- Will be populated by JavaScript --></div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-600">Loading bank accounts...</p>
        </div>

        <!-- Not Authenticated State -->
        <div id="notAuthenticatedState" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-lock text-6xl text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Connect to Xero</h2>
            <p class="text-gray-600 mb-6">Please connect your Xero account to view bank account balances.</p>
            <a href="/auth/xero" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                <i class="fas fa-plug mr-2"></i>Connect to Xero
            </a>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-600 text-2xl mr-3"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800">Error</h3>
                    <p id="errorMessage" class="text-red-600"></p>
                </div>
            </div>
            <button onclick="loadBankAccounts()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-redo mr-1"></i>Retry
            </button>
        </div>

        <!-- Bank Accounts Grid -->
        <div id="accountsContainer" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    Bank Accounts (<span id="accountsCount">0</span>)
                </h2>
                <button onclick="loadBankAccounts()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                </button>
            </div>
            <div id="accountsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Bank account cards will be inserted here -->
            </div>
        </div>

        <!-- No Accounts State -->
        <div id="noAccountsState" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-university text-6xl text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">No Bank Accounts Found</h2>
            <p class="text-gray-600">No bank accounts are currently connected to your Xero account.</p>
        </div>

        <!-- Transactions Modal -->
        <div id="transactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div>
                        <h2 id="modalAccountName" class="text-2xl font-semibold text-gray-800"></h2>
                        <p id="modalAccountCode" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <button onclick="closeTransactionsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Date Selector -->
                <div class="p-6 border-b border-gray-200 bg-gray-50">
                    <div class="flex items-center gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">Month:</label>
                            <select id="monthSelect" onchange="onDateChange()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">Year:</label>
                            <select id="yearSelect" onchange="onDateChange()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- Years will be populated by JavaScript -->
                            </select>
                        </div>
                        <button onclick="setCurrentMonth()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i class="fas fa-calendar-alt mr-1"></i>Current Month
                        </button>
                    </div>
                </div>

                <!-- Transactions Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Loading State -->
                    <div id="transactionsLoading" class="hidden text-center py-12">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600">Loading transactions...</p>
                    </div>

                    <!-- Error State -->
                    <div id="transactionsError" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3"></i>
                            <div>
                                <h3 class="text-lg font-semibold text-red-800">Error</h3>
                                <p id="transactionsErrorMessage" class="text-red-600"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div id="transactionsContainer" class="hidden">
                        <div class="mb-4 text-sm text-gray-600">
                            <span id="transactionsCount">0</span> transactions found
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Transactions will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- No Transactions State -->
                    <div id="noTransactionsState" class="hidden text-center py-12">
                        <i class="fas fa-receipt text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">No Transactions Found</h3>
                        <p class="text-gray-600">No transactions found for the selected period.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 100 Transactions Modal -->
        <div id="hundredTransactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800">100 Transactions (Any Account)</h2>
                    <button onclick="closeHundredTransactionsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="p-4 bg-gray-50 border-b border-gray-200 text-sm text-gray-600">
                    Showing the first 100 transactions from BankTransactions endpoint (unfiltered). Use this to see what transactions are available.
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="hundredTransactionsLoading" class="hidden text-center py-12">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600">Loading transactions...</p>
                    </div>
                    <div id="hundredTransactionsError" class="hidden text-center py-4 text-red-600"></div>
                    <div id="hundredTransactionsContainer" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account Code</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="hundredTransactionsTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Transactions Modal -->
        <div id="allTransactionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800">All Transactions (recent)</h2>
                    <button onclick="closeAllTransactionsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="p-4 bg-gray-50 border-b border-gray-200 text-sm text-gray-600">
                    Showing the most recent transactions returned by Xero (first few pages). Use this to reconcile account IDs/names.
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="allTransactionsLoading" class="hidden text-center py-12">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600">Loading transactions...</p>
                    </div>
                    <div id="allTransactionsError" class="hidden text-center py-4 text-red-600"></div>
                    <div id="allTransactionsContainer" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="allTransactionsTable" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication status on page load
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Failed to check auth status', error);
                return false;
            }
        }

        // Load bank accounts
        async function loadBankAccounts() {
            const loadingState = document.getElementById('loadingState');
            const accountsContainer = document.getElementById('accountsContainer');
            const noAccountsState = document.getElementById('noAccountsState');
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');

            // Hide all states
            loadingState.classList.remove('hidden');
            accountsContainer.classList.add('hidden');
            noAccountsState.classList.add('hidden');
            errorState.classList.add('hidden');

            try {
                const response = await fetch('/api/xero/accounts');
                const data = await response.json();

                if (response.status === 401) {
                    // Not authenticated
                    showNotAuthenticatedState();
                    return;
                }

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch bank accounts');
                }

                loadingState.classList.add('hidden');

                if (data.accounts && data.accounts.length > 0) {
                    displayBankAccounts(data.accounts);
                    accountsContainer.classList.remove('hidden');
                } else {
                    noAccountsState.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading bank accounts', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message || 'Failed to load bank accounts. Please try again.';
            }
        }

        // Display bank accounts
        function displayBankAccounts(accounts) {
            const grid = document.getElementById('accountsGrid');
            const countElement = document.getElementById('accountsCount');
            
            countElement.textContent = accounts.length;

            grid.innerHTML = accounts.map(account => `
                <div onclick="showTransactions('${escapeHtml(account.accountId)}', '${escapeHtml(account.name)}', '${escapeHtml(account.code)}')" class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-university text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${escapeHtml(account.name)}</h3>
                                <p class="text-sm text-gray-500">${escapeHtml(account.code)}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                            account.status === 'ACTIVE' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-gray-100 text-gray-800'
                        }">
                            ${account.status}
                        </span>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex items-baseline justify-between mb-2">
                            <span class="text-sm text-gray-600">Balance</span>
                            <span class="text-2xl font-bold ${
                                account.balance >= 0 ? 'text-green-600' : 'text-red-600'
                            }">
                                ${account.balanceFormatted}
                            </span>
                        </div>
                        ${account.bankAccountNumber ? `
                            <div class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-credit-card mr-1"></i>
                                ${escapeHtml(account.bankAccountNumber)}
                            </div>
                        ` : ''}
                        <div class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-coins mr-1"></i>
                            ${escapeHtml(account.currencyCode)}
                        </div>
                        <div class="text-xs text-blue-600 mt-3 font-medium">
                            <i class="fas fa-eye mr-1"></i>Click to view transactions
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show not authenticated state
        function showNotAuthenticatedState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('accountsContainer').classList.add('hidden');
            document.getElementById('noAccountsState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('notAuthenticatedState').classList.remove('hidden');
        }

        // Update auth section in header
        async function updateAuthSection() {
            const authSection = document.getElementById('authSection');
            const isAuthenticated = await checkAuthStatus();

            if (isAuthenticated) {
                authSection.innerHTML = `
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </button>
                `;
            } else {
                authSection.innerHTML = `
                    <a href="/auth/xero" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plug mr-1"></i>Connect to Xero
                    </a>
                `;
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                });
                if (response.ok || response.redirected) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Logout failed', error);
                window.location.reload();
            }
        }

        // Transactions modal state
        let currentAccountId = null;
        let currentAccountName = '';
        let currentAccountCode = '';

        // Initialize year dropdown
        function initializeYearDropdown() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            const startYear = 2020;
            const endYear = currentYear + 5;
            
            yearSelect.innerHTML = '';
            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Set month/year to current month
        function setCurrentMonth() {
            const now = new Date();
            document.getElementById('monthSelect').value = now.getMonth() + 1;
            document.getElementById('yearSelect').value = now.getFullYear();
            onDateChange();
        }

        // Show transactions modal
        function showTransactions(accountId, accountName, accountCode) {
            currentAccountId = accountId;
            currentAccountName = accountName;
            currentAccountCode = accountCode;
            
            document.getElementById('modalAccountName').textContent = accountName;
            document.getElementById('modalAccountCode').textContent = `Account Code: ${accountCode}`;
            
            // Set to current month/year
            setCurrentMonth();
            
            // Show modal
            document.getElementById('transactionsModal').classList.remove('hidden');
            
            // Load transactions
            loadTransactions();
        }

        // Close transactions modal
        function closeTransactionsModal() {
            document.getElementById('transactionsModal').classList.add('hidden');
            currentAccountId = null;
        }

        // Handle date change
        function onDateChange() {
            if (currentAccountId) {
                loadTransactions();
            }
        }

        // Load transactions for selected account and date
        async function loadTransactions() {
            if (!currentAccountId) return;

            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            
            const loadingState = document.getElementById('transactionsLoading');
            const transactionsContainer = document.getElementById('transactionsContainer');
            const noTransactionsState = document.getElementById('noTransactionsState');
            const errorState = document.getElementById('transactionsError');
            const errorMessage = document.getElementById('transactionsErrorMessage');

            // Hide all states
            loadingState.classList.remove('hidden');
            transactionsContainer.classList.add('hidden');
            noTransactionsState.classList.add('hidden');
            errorState.classList.add('hidden');

            try {
                const response = await fetch(`/api/xero/accounts/${currentAccountId}/transactions?month=${month}&year=${year}&accountName=${encodeURIComponent(currentAccountName)}&accountCode=${encodeURIComponent(currentAccountCode)}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to fetch transactions');
                }

                loadingState.classList.add('hidden');

                if (data.transactions && data.transactions.length > 0) {
                    displayTransactions(data.transactions);
                    document.getElementById('transactionsCount').textContent = data.count;
                    transactionsContainer.classList.remove('hidden');
                } else {
                    noTransactionsState.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading transactions', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message || 'Failed to load transactions. Please try again.';
            }
        }

        // Display transactions
        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionsTableBody');
            
            tbody.innerHTML = transactions.map(tx => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatTransactionDate(tx.date)}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        ${escapeHtml(tx.description)}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${tx.reference ? escapeHtml(tx.reference) : '-'}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${tx.contactName ? escapeHtml(tx.contactName) : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${
                        tx.amount >= 0 ? 'text-green-600' : 'text-red-600'
                    }">
                        ${tx.amountFormatted}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            tx.isReconciled 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-gray-100 text-gray-800'
                        }">
                            ${tx.isReconciled ? 'Reconciled' : 'Unreconciled'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Format transaction date
        function formatTransactionDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('transactionsModal');
            if (e.target === modal) {
                closeTransactionsModal();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            initializeYearDropdown();
            await updateAuthSection();
            const isAuthenticated = await checkAuthStatus();
            
            if (isAuthenticated) {
                await loadBankAccounts();
                const allBtn = document.getElementById('allTransactionsBtn');
                if (allBtn) {
                    allBtn.addEventListener('click', () => showAllTransactions());
                }
                const hundredBtn = document.getElementById('hundredTransactionsBtn');
                if (hundredBtn) {
                    hundredBtn.addEventListener('click', () => showHundredTransactions());
                }
            } else {
                showNotAuthenticatedState();
            }
        });

        // All transactions modal logic
        async function showAllTransactions() {
            const modal = document.getElementById('allTransactionsModal');
            const loading = document.getElementById('allTransactionsLoading');
            const container = document.getElementById('allTransactionsContainer');
            const error = document.getElementById('allTransactionsError');
            const table = document.getElementById('allTransactionsTable');

            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            container.classList.add('hidden');
            error.classList.add('hidden');
            table.innerHTML = '';

            try {
                const response = await fetch('/api/xero/transactions/all?pages=10');
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to fetch all transactions');

                if (data.transactions && data.transactions.length > 0) {
                    const rows = data.transactions.map(tx => `
                        <tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${escapeHtml(tx.date || '')}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${escapeHtml(tx.bankAccountName || '')}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${escapeHtml(tx.bankAccountId || '')}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${escapeHtml(tx.bankAccountCode || '')}</td>
                            <td class="px-4 py-2 text-sm text-gray-700">${escapeHtml(tx.description || '')}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-right text-sm ${'amount' in tx && tx.amount >= 0 ? 'text-green-600' : 'text-red-600'}">${escapeHtml(tx.amountFormatted || '')}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${escapeHtml(tx.type || '')}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${escapeHtml(tx.status || '')}</td>
                        </tr>
                    `).join('');
                    table.innerHTML = rows;
                    loading.classList.add('hidden');
                    container.classList.remove('hidden');
                } else {
                    loading.classList.add('hidden');
                    error.textContent = 'No transactions were returned by Xero.';
                    error.classList.remove('hidden');
                }
            } catch (e) {
                loading.classList.add('hidden');
                error.textContent = e.message || 'Failed to load transactions.';
                error.classList.remove('hidden');
            }
        }

        function closeAllTransactionsModal() {
            document.getElementById('allTransactionsModal').classList.add('hidden');
        }
    </script>
</body>
</html>

