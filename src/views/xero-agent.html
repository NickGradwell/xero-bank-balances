<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xero Login Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-robot mr-2 text-blue-600"></i>
                        Xero Login Agent
                    </h1>
                    <p class="text-gray-600 mt-1">Automated browser agent for logging into Xero</p>
                </div>
                <div>
                    <a href="/" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left mr-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- TOTP Secret Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-shield-alt mr-2 text-green-600"></i>2FA Configuration
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label for="totpSecretInput" class="block text-sm font-medium text-gray-700 mb-2">
                            TOTP Secret Key
                        </label>
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="totpSecretInput" 
                                placeholder="Enter your TOTP secret key"
                                class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                            <button id="saveTotpSecretBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                <i class="fas fa-save mr-1"></i>Save
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Enter the secret key from your authenticator app or generate a new one below.
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button id="generateTotpSecretBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i class="fas fa-key mr-1"></i>Generate New Key
                        </button>
                        <button id="testTotpSecretBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i class="fas fa-vial mr-1"></i>Test Secret
                        </button>
                        <button id="previewTotpCodeBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i class="fas fa-eye mr-1"></i>Preview Code
                        </button>
                    </div>
                    <div id="totpStatus" class="text-sm"></div>
                </div>
                <div class="space-y-4">
                    <div id="qrCodeContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            QR Code for Setup
                        </label>
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 flex justify-center">
                            <img id="qrCodeImg" src="" alt="QR Code" class="max-w-xs">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)
                        </p>
                    </div>
                    <div id="generatedSecretContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Generated Secret
                        </label>
                        <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 font-mono text-sm break-all">
                            <span id="generatedSecretText"></span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            Copy this secret and save it securely. You'll need to set it as the XERO_TOTP_SECRET environment variable.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Agent Controls</h2>
            <div class="flex gap-4 items-center">
                <button id="runAgentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
                    <i class="fas fa-play mr-2"></i>Run Login Agent
                </button>
                <button id="stopAgentBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors" disabled>
                    <i class="fas fa-stop mr-2"></i>Stop Agent
                </button>
                <button id="refreshStatusBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh Status
                </button>
                <div class="flex items-center gap-2 ml-auto">
                    <input type="checkbox" id="headlessMode" class="h-4 w-4 text-blue-600 border-gray-300 rounded" checked>
                    <label for="headlessMode" class="text-sm text-gray-700">Headless Mode</label>
                </div>
            </div>
        </div>

        <!-- Status Display -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Status</h2>
            <div id="statusDisplay" class="space-y-2">
                <div class="text-gray-600">No agent running</div>
            </div>
        </div>

        <!-- Screenshot Display -->
        <div id="screenshotContainer" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Current View</h2>
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <img id="screenshotImg" src="" alt="Screenshot" class="max-w-full rounded-lg">
            </div>
        </div>

        <!-- Logs Display -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Logs</h2>
                <button id="clearLogsBtn" class="text-sm text-gray-600 hover:text-gray-800">
                    <i class="fas fa-trash mr-1"></i>Clear Logs
                </button>
            </div>
            <div id="logsContainer" class="bg-gray-900 text-green-400 font-mono text-sm p-4 rounded-lg max-h-96 overflow-y-auto">
                <div class="text-gray-500">No logs yet...</div>
            </div>
        </div>
    </div>

    <script>
        let statusPollInterval = null;

        function formatTimestamp(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function updateLogs(logs) {
            const container = document.getElementById('logsContainer');
            if (!container) return;

            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No logs yet...</div>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const timestamp = formatTimestamp(log.timestamp);
                const errorClass = log.error ? 'text-red-400' : '';
                return `
                    <div class="mb-1 ${errorClass}">
                        <span class="text-gray-500">[${timestamp}]</span>
                        <span class="text-yellow-400">[${log.step}]</span>
                        <span>${escapeHtml(log.message)}</span>
                        ${log.error ? `<span class="text-red-400"> - Error: ${escapeHtml(log.error)}</span>` : ''}
                    </div>
                `;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(data) {
            const statusDisplay = document.getElementById('statusDisplay');
            if (!statusDisplay) return;

            if (!data.running) {
                statusDisplay.innerHTML = '<div class="text-gray-600">No agent running</div>';
                return;
            }

            const urlDisplay = data.currentUrl ? `<div class="text-sm text-blue-600 break-all">URL: ${escapeHtml(data.currentUrl)}</div>` : '';
            
            statusDisplay.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="font-semibold text-green-600">Agent Running</span>
                </div>
                ${urlDisplay}
            `;

            if (data.screenshot) {
                const container = document.getElementById('screenshotContainer');
                const img = document.getElementById('screenshotImg');
                if (container && img) {
                    container.classList.remove('hidden');
                    img.src = `data:image/png;base64,${data.screenshot}`;
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text ?? '';
            return div.innerHTML;
        }

        async function runAgent() {
            const btn = document.getElementById('runAgentBtn');
            const stopBtn = document.getElementById('stopAgentBtn');
            const headlessCheckbox = document.getElementById('headlessMode');
            
            if (btn) btn.disabled = true;
            if (stopBtn) stopBtn.disabled = false;

            try {
                const headless = headlessCheckbox ? headlessCheckbox.checked : true;
                const response = await fetch('/api/xero/login-agent/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ headless }),
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Login successful! URL: ' + result.url);
                    updateStatus({ running: false, currentUrl: result.url, screenshot: result.screenshot });
                    if (result.screenshot) {
                        const container = document.getElementById('screenshotContainer');
                        const img = document.getElementById('screenshotImg');
                        if (container && img) {
                            container.classList.remove('hidden');
                            img.src = `data:image/png;base64,${result.screenshot}`;
                        }
                    }
                } else {
                    alert('Login failed: ' + (result.error || result.message));
                    updateStatus({ running: false, screenshot: result.screenshot });
                    if (result.screenshot) {
                        const container = document.getElementById('screenshotContainer');
                        const img = document.getElementById('screenshotImg');
                        if (container && img) {
                            container.classList.remove('hidden');
                            img.src = `data:image/png;base64,${result.screenshot}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error running agent', error);
                alert('Error running agent: ' + (error instanceof Error ? error.message : 'Unknown error'));
            } finally {
                if (btn) btn.disabled = false;
                if (stopBtn) stopBtn.disabled = true;
            }
        }

        async function stopAgent() {
            try {
                await fetch('/api/xero/login-agent/stop', { method: 'POST' });
                updateStatus({ running: false });
                stopStatusPolling();
            } catch (error) {
                console.error('Error stopping agent', error);
            }
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/api/xero/login-agent/status');
                const data = await response.json();
                updateStatus(data);
                if (data.logs) {
                    updateLogs(data.logs);
                }
            } catch (error) {
                console.error('Error refreshing status', error);
            }
        }

        function startStatusPolling() {
            if (statusPollInterval) return;
            statusPollInterval = setInterval(refreshStatus, 2000);
        }

        function stopStatusPolling() {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }
        }

        function clearLogs() {
            const container = document.getElementById('logsContainer');
            if (container) {
                container.innerHTML = '<div class="text-gray-500">No logs yet...</div>';
            }
        }

        async function loadTotpSecret() {
            try {
                const response = await fetch('/api/xero/totp-secret');
                const data = await response.json();
                const input = document.getElementById('totpSecretInput');
                const status = document.getElementById('totpStatus');
                
                if (input) {
                    if (data.configured) {
                        input.value = data.secret; // Will show masked version
                        input.placeholder = 'TOTP secret is configured (masked)';
                    } else {
                        input.value = '';
                        input.placeholder = 'Enter your TOTP secret key';
                    }
                }
                
                if (status) {
                    if (data.configured) {
                        status.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>TOTP secret is configured</span>';
                    } else {
                        status.innerHTML = '<span class="text-amber-600"><i class="fas fa-exclamation-triangle mr-1"></i>TOTP secret not configured. 2FA login will fail if required.</span>';
                    }
                }
            } catch (error) {
                console.error('Error loading TOTP secret', error);
            }
        }

        async function saveTotpSecret() {
            const input = document.getElementById('totpSecretInput');
            const status = document.getElementById('totpStatus');
            
            if (!input) return;
            
            const secret = input.value.trim();
            if (!secret) {
                if (status) {
                    status.innerHTML = '<span class="text-red-600">Please enter a TOTP secret</span>';
                }
                return;
            }

            if (status) {
                status.innerHTML = '<span class="text-gray-600">Saving...</span>';
            }

            try {
                const response = await fetch('/api/xero/totp-secret', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secret }),
                });

                const data = await response.json();
                
                if (response.ok) {
                    if (status) {
                        status.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>' + (data.message || 'TOTP secret saved') + '</span>';
                    }
                    // Note: In production, you'd need to set this as an environment variable
                    alert('TOTP secret validated. For production use, set XERO_TOTP_SECRET environment variable with this value.');
                } else {
                    if (status) {
                        status.innerHTML = '<span class="text-red-600">' + (data.error || 'Failed to save TOTP secret') + '</span>';
                    }
                }
            } catch (error) {
                console.error('Error saving TOTP secret', error);
                if (status) {
                    status.innerHTML = '<span class="text-red-600">Error saving TOTP secret</span>';
                }
            }
        }

        async function generateTotpSecret() {
            const status = document.getElementById('totpStatus');
            const qrContainer = document.getElementById('qrCodeContainer');
            const qrImg = document.getElementById('qrCodeImg');
            const secretContainer = document.getElementById('generatedSecretContainer');
            const secretText = document.getElementById('generatedSecretText');
            const input = document.getElementById('totpSecretInput');

            if (status) {
                status.innerHTML = '<span class="text-gray-600">Generating...</span>';
            }

            try {
                const response = await fetch('/api/xero/totp-secret/generate', {
                    method: 'POST',
                });

                const data = await response.json();
                
                if (response.ok) {
                    if (input) {
                        input.value = data.secret;
                    }
                    
                    if (secretText) {
                        secretText.textContent = data.secret;
                    }
                    
                    if (qrImg && data.qrCode) {
                        qrImg.src = data.qrCode;
                        if (qrContainer) {
                            qrContainer.classList.remove('hidden');
                        }
                    }
                    
                    if (secretContainer) {
                        secretContainer.classList.remove('hidden');
                    }
                    
                    if (status) {
                        status.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>' + (data.message || 'New secret generated') + '</span>';
                    }
                } else {
                    if (status) {
                        status.innerHTML = '<span class="text-red-600">' + (data.error || 'Failed to generate secret') + '</span>';
                    }
                }
            } catch (error) {
                console.error('Error generating TOTP secret', error);
                if (status) {
                    status.innerHTML = '<span class="text-red-600">Error generating TOTP secret</span>';
                }
            }
        }

        async function testTotpSecret() {
            const input = document.getElementById('totpSecretInput');
            const status = document.getElementById('totpStatus');
            
            if (!input) return;
            
            const secret = input.value.trim();
            if (!secret) {
                if (status) {
                    status.innerHTML = '<span class="text-red-600">Please enter a TOTP secret to test</span>';
                }
                return;
            }

            if (status) {
                status.innerHTML = '<span class="text-gray-600">Testing secret...</span>';
            }

            try {
                const response = await fetch('/api/xero/totp-secret/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secret }),
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    if (status) {
                        status.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Secret is valid! Generated codes: ${data.codes.join(', ')}</span>`;
                    }
                    alert(`✅ TOTP Secret Test Successful!\n\nGenerated codes: ${data.codes.join(', ')}\n\nSecret length: ${data.secretLength} characters\nFormat: ${data.format || 'base32'}\n\n${data.note || ''}`);
                } else {
                    if (status) {
                        status.innerHTML = '<span class="text-red-600">' + (data.error || 'Test failed') + '</span>';
                    }
                    alert('❌ TOTP Secret Test Failed\n\n' + (data.error || 'Unknown error') + '\n\n' + (data.message || '') + '\n\n' + (data.hint || ''));
                }
            } catch (error) {
                console.error('Error testing TOTP secret', error);
                if (status) {
                    status.innerHTML = '<span class="text-red-600">Error testing TOTP secret</span>';
                }
                alert('Error testing TOTP secret: ' + (error instanceof Error ? error.message : 'Unknown error'));
            }
        }

        async function previewTotpCode() {
            const input = document.getElementById('totpSecretInput');
            
            if (!input) return;
            
            const secret = input.value.trim();
            if (!secret) {
                alert('Please enter a TOTP secret first');
                return;
            }

            try {
                const response = await fetch('/api/xero/totp-code/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secret }),
                });
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Current TOTP Code: ${data.code}\n\nThis code will expire in ${data.remainingSeconds} seconds.\n\nServer time: ${data.serverTime || 'N/A'}\nSecret length: ${data.secretLength || 'N/A'} characters\n\nUse this code for manual login if needed.\n\nCompare this with your authenticator app to verify they match.`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate code') + '\n\n' + (data.message || '') + '\n\n' + (data.hint || ''));
                }
            } catch (error) {
                console.error('Error previewing TOTP code', error);
                alert('Error generating TOTP code preview');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const runBtn = document.getElementById('runAgentBtn');
            const stopBtn = document.getElementById('stopAgentBtn');
            const refreshBtn = document.getElementById('refreshStatusBtn');
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            const saveTotpBtn = document.getElementById('saveTotpSecretBtn');
            const generateTotpBtn = document.getElementById('generateTotpSecretBtn');
            const testTotpBtn = document.getElementById('testTotpSecretBtn');
            const previewTotpBtn = document.getElementById('previewTotpCodeBtn');

            if (runBtn) {
                runBtn.addEventListener('click', () => {
                    runAgent();
                    startStatusPolling();
                });
            }

            if (stopBtn) {
                stopBtn.addEventListener('click', () => {
                    stopAgent();
                });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshStatus);
            }

            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', clearLogs);
            }

            if (saveTotpBtn) {
                saveTotpBtn.addEventListener('click', saveTotpSecret);
            }

            if (generateTotpBtn) {
                generateTotpBtn.addEventListener('click', generateTotpSecret);
            }

            if (testTotpBtn) {
                testTotpBtn.addEventListener('click', testTotpSecret);
            }

            if (previewTotpBtn) {
                previewTotpBtn.addEventListener('click', previewTotpCode);
            }

            // Load TOTP secret status on page load
            loadTotpSecret();

            // Initial status check
            refreshStatus();
        });
    </script>
</body>
</html>

